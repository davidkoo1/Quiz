@using WebApplication2.Models.API;
@using WebApplication2.Models.Enum;
@using WebApplication2.ViewModels;
@using Newtonsoft.Json
@model CreateQuestionnaireViewModel

@{
    ViewData["Title"] = "Edit";
    Layout = "~/Views/_Shared/_Layout.cshtml";
}
<script src="~/js/app.js"></script>

<style>
    .question {
        border: 1px solid #2c3036;
        border-radius: 10px;
        padding: 10px;
        margin: 20px 0;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    }

    .btn-remove {
        display: none;
    }

    #add-answer {
        display: none;
    }


</style>
@{
    int i = 0;
}
<form method="POST" asp-controller="Home" asp-action="EditQuestionnaire" id="EditQuestionnaireForm" enctype="multipart/form-data">
    <div class="form-container">
        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title mb-4">Edit Questionnaire</h4>
                        <input type="hidden" asp-for="oid" id="mainId" />
                        <div class="form-group">
                            <label asp-for="Title">Title</label>
                            <input type="text" name="Title" asp-for="Title" class=" form-control" id="titleQ" />
                            <span asp-validation-for="Title" class="text-danger"></span>
                        </div>
                        <br/>
                        <h3>Questions</h3>
                        <div id="questions-container">

                            @foreach (var item in Model.Questions)
                            {
                                <div class="question" id="question_@i">
                                    <input type='button' style="width: 100%;" class='btn btn-danger waves-effect waves-light btnremove ' value='Delete question' />

                                    <div class="form-group">
                                        <label asp-for="@item.question">Question Text</label>
                                        <input type="text" name="@item.question" asp-for="@item.question" class=" form-control" id="questionName_@i" />
                                    </div>
                                    <div class="form-group">
                                        @*Исправить если мы выбрали мультиАнсв, то кнопка появляется(сделать кнопку на удаление ответов)*@
                                        <label asp-for="@item.gradingType">GradingType</label>
                                        <select id="questionGradingType_@i" name=".gradingType" class="form-control">
                                            <option value="1" selected="@(item.gradingType == GradingType.YesNo)">Yes or No</option>
                                            <option value="2" selected="@(item.gradingType == GradingType.Point10Score)">Score 10 points</option>
                                            <option value="3" selected="@(item.gradingType == GradingType.SingleAnswerVariant)">One answer variant</option>
                                            <option value="4" selected="@(item.gradingType == GradingType.MultipleAnswerVariant)">Multi answer variant</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label asp-for="@item.comentary">Commentary</label>
                                        <input type="text" name="@item.comentary" asp-for="@item.comentary" class="form-control" id="questionComentary_@i" />
                                    </div>
                                    <div class="answers-container">
                                        @{
                                            int j = 0;
                                        }
                                        @if (item.gradingType == GradingType.SingleAnswerVariant || item.gradingType == GradingType.MultipleAnswerVariant)
                                        {
                                            @foreach (var answ in item.answerVariants)
                                            {

                                                <div class="answer">
                                                    <div class="form-group">
                                                        <label asp-for="@answ">Answer Text</label>
                                                        <input type="text" asp-for="@answ" class="form-control" id="answerVal_@j" />
                                                        <input type='button' id='btnremoveAnsw' style="width: 100%;" class='btn btn-danger waves-effect waves-light' value='Delete answer' />
                                                    </div>
                                                </div>
                                                j++;
                                            }
                                        }
                                    </div>
                                    <button type="button" id="add-answer" style="width: 100%; margin-top: 10px;" class="btn btn-info waves-effect waves-light">Add Answer</button>
                                </div>
                                i++;
                            }
                        </div>
                        <button type="button" id="add-question" style="margin-top: 10px; width: 100%;" class="btn btn-primary waves-effect waves-light">Add Question</button>
                        <button type="submit" style="margin-top: 10px; width: 100%;" class="btn btn-outline-success waves-effect waves-light">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>


@section scripts {
    <script>
        $(document).ready(function () {
            var questionIndex = @i;

            function addQuestion() {
                var questionHtml = `
                    <div class="question" id="question_${questionIndex}">
                        <input type='button' style="width: 100%;" class='btn btn-danger waves-effect waves-light btnremove ${questionIndex === 0 ? 'hidden' : ''}' value='Delete question'/>
                        <div class="form-group">
                            <label for="Questions_${questionIndex}__Text">Question Text</label>
                                <input type="text" name="Questions[${questionIndex}].question" class="form-control" id="questionName_${questionIndex}"/>
                        </div>
                        <div class="form-group">
                            <label for="Questions_${questionIndex}__gradingType">Grading Type</label>
                                <select id="questionGradingType_${questionIndex}" name="Questions[${questionIndex}].gradingType" class="form-control">
                                <option value="1">Yes or No</option>
                                <option value="2">Score 10 points</option>
                                <option value="3">One answer variant</option>
                                <option value="4">Multi answer variant</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="Questions_${questionIndex}__comentary">Commentary</label>
                            <input type="text" name="Questions[${questionIndex}].comentary" class="form-control"  id="questionComentary_${questionIndex}" />
                        </div>
                        <div class="answers-container" style="display: none;">
                            <h4>Answers</h4>
                            <div class="answer">
                                <div class="form-group">
                                    <label for="Questions_${questionIndex}__Answers_0__Text">Answer Text</label>
                                    <input type="text" name="Questions[${questionIndex}].answerVariants[0]" class="form-control" id="answerVal_${questionIndex}_0"/>
                                </div>
                            </div>
                        </div>
                                                        <button type="button" id="add-answer" style="display: none; width: 100%; margin-top: 10px;" class="btn btn-info waves-effect waves-light">Add Answer</button>
                    </div>`;

                $("#questions-container").append(questionHtml);
                questionIndex++;
                addRemoveAction();
                addRemoveAnswerAction();
            }

            $("#questionGradingType_@i").change(function () {
                // Получаем выбранное значение
                var selectedValue = $(this).val();

                // Проверяем, является ли выбранное значение 3 или 4
                if (selectedValue == "3" || selectedValue == "4") {
                    // Показываем кнопку Add Answer
                    $("#add-answer").show();
                } else {
                    // Скрываем кнопку Add Answer
                    $("#add-answer").hide();
                }
            });

            function addRemoveAction() {
                $(".btnremove").each(function (index, item) {
                    $(item).click(function () {
                        var $question = $(this).closest('.question');
                        $question.remove();
                    });
                });
            }

            function addRemoveAnswerAction() {
                $("#questions-container").on("click", "#btnremoveAnsw", function () {
                    var $answer = $(this).closest('.answer');
                    $answer.remove();
                });
            }

            $("#add-question").click(function () {
                addQuestion();
            });

            $("#questions-container").on("change", "select[id*='questionGradingType_']", function () {
                var $question = $(this).closest(".question");
                var $answersContainer = $question.find(".answers-container");
                var $addAnswerButton = $question.find("#add-answer");



                if ($(this).val() == "4" || $(this).val() == "3") { // Показать поле для ответов только при выборе "Multi answer variant"
                    $answersContainer.show();
                    $addAnswerButton.show();
                    // $removeAnswerButton.show();
                }
                else {
                    $answersContainer.hide();
                    $addAnswerButton.hide();
                }
                
            });

            $("#questions-container").on("click", "#add-answer", function () {
                var $question = $(this).closest(".question");
                var $answersContainer = $question.find(".answers-container");
                var answerIndex = $answersContainer.find(".answer").length;

                var answerHtml = `<div class="answer">
                                                <div class="form-group">
                                                    <label for="Questions_${questionIndex}__Answers_${answerIndex}__Text">Answer Text</label>
                                                    <input type="text" name="Questions[${questionIndex}].answerVariants[${answerIndex}]"  class="form-control" id="answerVal_${questionIndex}_${answerIndex}"/>
                                                    <input type='button' id='btnremoveAnsw' style="width: 100%;" class='btn btn-danger waves-effect waves-light ${answerIndex === 0 ? 'hidden' : ''}' value='Delete answer'/>
                                                </div>
                                            </div>`;

                $answersContainer.append(answerHtml);
                addRemoveAnswerAction();
            });

            addRemoveAction();
            addRemoveAnswerAction();

            $('#EditQuestionnaireForm').on('submit', function (e) {
                e.preventDefault();
                var questions = [];

                //debugger
                let divsSetQuestions = $('#questions-container').find('div[id*="question_"]');
                divsSetQuestions.each(function (e, element) {
                    var answerRes = [];
                    let questionName = $("#" + element.id).find("input[id*='questionName_']");
                    let questionGradingType = $("#" + element.id).find("select[id*='questionGradingType_']");
                    let questionComentary = $("#" + element.id).find("input[id*='questionComentary_']");
                    let answerVal = $("#" + element.id).find("input[id*='answerVal_']");
                    if (answerVal.length > 0) {
                        answerVal.each(function (e, answElement) {
                            answerRes.push(answElement.value);
                        });
                    }
                    else {
                        answerRes.push(null);
                    }
                    questions.push({ question: questionName[0].value, gradingType: questionGradingType[0].value, comentary: questionComentary[0].value, answerVariants: answerRes });
                });

                var Quest = {
                    id: $('#mainId').val(),
                    Title: $('#titleQ').val(),
                    Questions: JSON.stringify({ questions }),
                };
                //debugger
                $.ajax({
                    url: '/Home/EditQuestionnaire',
                    cache: false,
                    type: "POST",
                    data: JSON.stringify(Quest),
                    contentType: "application/json; charset=utf-8",
                    success: function (data) {
                        if (data.statusCode === 200) {
                            window.location.href = '/Home/Index';
                        } else {

                        }
                    },

                });
            });
        });
    </script>
}

